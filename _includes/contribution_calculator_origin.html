<div id="calculator-container">
  <h2>보스 선택</h2>
  <select id="raid-select" onchange="updateDifficulties()">
    <option value="">레이드 선택</option>
    {% assign raids = site.data.boss_data | keys %} {% for raid in raids %}
    <option value="{{ raid }}">{{ raid }}</option>
    {% endfor %}
  </select>

  <select id="difficulty-select" onchange="updateGates()">
    <option value="">난이도 선택</option>
  </select>

  <select id="gate-select" onchange="updateHp()">
    <option value="">관문 선택</option>
  </select>

  <h2>직접 입력</h2>
  보스 체력(억): <input id="boss-hp" type="number" min="0" /><br />
  파티 인원:
  <select id="party-size">
    <option value="4">4인</option>
    <option value="8">8인</option>
    <option value="16">16인</option></select
  ><br />
  입힌 데미지(억): <input id="user-damage" type="number" min="0" /><br />

  <button onclick="calculateContribution()">계산하기</button>
  <button onclick="showThresholds()">기준점 보기</button>

  <div id="result-area"></div>
  <div id="threshold-area"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
<script>
  
  const bossData = {{ site.data.boss_data | jsonify }};
  const thresholds = {
    4: { 투사: [0,29], 강직한_투사: [30,39], 잔혹한_혈투사: [40,100] },
    8: { 투사: [0,14], 강직한_투사: [15,19], 잔혹한_혈투사: [20,100] },
    16: { 투사: [0,7], 강직한_투사: [8,10], 잔혹한_혈투사: [11,100] }  // 16인 추가 (추정 기준)
  };

  function updateDifficulties() {
    console.log('updateDifficulties fired');
    const raid = document.getElementById('raid-select').value;
    const diffSel = document.getElementById('difficulty-select');
    diffSel.innerHTML = '<option value="">난이도 선택</option>';
    if (!raid || !bossData[raid]) return;
    Object.keys(bossData[raid]).forEach(diff => {
      const opt = document.createElement('option');
      opt.value = diff;
      opt.textContent = diff;
      diffSel.appendChild(opt);
    });
    updateGates();  // 난이도 변경 시 관문 업데이트
  }

  function updateGates() {
    const raid = document.getElementById('raid-select').value;
    const diff = document.getElementById('difficulty-select').value;
    const gateSel = document.getElementById('gate-select');
    gateSel.innerHTML = '<option value="">관문 선택</option>';
    if (!raid || !diff || !bossData[raid][diff]) return;
    bossData[raid][diff].forEach(gate => {
      const opt = document.createElement('option');
      opt.value = gate.hp;
      opt.innerText = gate.gate + ' (' + gate.hp + '억)';
      gateSel.appendChild(opt);
    });
  }

  function updateHp() {
    const hp = document.getElementById('gate-select').value;
    document.getElementById('boss-hp').value = hp;
  }

  function calculateContribution() {
    const hp = parseFloat(document.getElementById('boss-hp').value) * 1e8;
    const dmg = parseFloat(document.getElementById('user-damage').value) * 1e8;
    const party = parseInt(document.getElementById('party-size').value);
    if (!hp || !dmg) return alert('값을 모두 입력하세요');
    const pct = dmg / hp * 100;
    let grade = '해당 없음';
    const thr = thresholds[party];
    if (!thr) return alert('지원되지 않는 파티 인원입니다.');
    for (let key in thr) {
      const [min, max] = thr[key];
      if (pct >= min && (max === 100 || pct < max)) { grade = key.replace(/_/g, ' '); break; }
    }
    document.getElementById('result-area').innerHTML =
      `<h3>결과</h3>
       기여도: ${pct.toFixed(2)}%<br>
       등급: <strong>${grade}</strong>`;
  }

  function showThresholds() {
    const hpVal = parseFloat(document.getElementById('boss-hp').value);
    const party = parseInt(document.getElementById('party-size').value);
    if (!hpVal) return alert('보스 체력을 입력하세요');
    const hp = hpVal * 1e8;
    const thr = thresholds[party];
    if (!thr) return alert('지원되지 않는 파티 인원입니다.');
    let html = '<h3>기준점</h3><table><tr><th>등급</th><th>퍼센트</th><th>데미지(억)</th></tr>';
    for (let key in thr) {
      const [min, max] = thr[key];
      const minD = (hp * min / 100 / 1e8).toFixed(2);
      const maxD = max === 100 ? '무제한' : (hp * max / 100 / 1e8).toFixed(2);
      html += `<tr>
        <td>${key.replace(/_/g, ' ')}</td>
        <td>${min}%~${max === 100 ? '이상' : max + '%'}</td>
        <td>${minD}억 ~ ${maxD}억</td>
      </tr>`;
    }
    html += '</table>';
    document.getElementById('threshold-area').innerHTML = html;
  }
</script>
<style>
  #calculator-container {
    max-width: 600px;
    margin: 20px auto;
  }
  select,
  input {
    margin: 5px 0;
    width: 100%;
    padding: 8px;
  }
  button {
    margin: 10px 5px;
    padding: 8px 16px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th,
  td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
  }
</style>
